console.log("ðŸ“¦ Perplexity Prompt Counter loaded");let o=0,l=null,p=null,n="",s="";chrome.storage.local.get(["today_perplexity_prompts"],t=>{o=parseInt(t.today_perplexity_prompts||"0"),console.log(`ðŸ”„ Loaded existing Perplexity prompts count: ${o}`),g()});function g(){a(),setInterval(a,2e3),window.addEventListener("popstate",()=>{console.log("ðŸ”„ Navigation detected, reinitializing..."),setTimeout(()=>{l=null,i()},500)}),window.addEventListener("hashchange",()=>{console.log("ðŸ”„ Hash change detected, reinitializing..."),setTimeout(()=>{l=null,i()},500)}),console.log("ðŸš€ Perplexity Prompt Counter system initialized")}function i(){const t=document.querySelector("#ask-input")||document.querySelector('[role="textbox"]')||document.querySelector('[contenteditable="true"]');if(!t||t===l)return!1;console.log("ðŸ”„ Initializing tracking for new Perplexity input field"),l=t,n="",s="";const r=()=>{s=t.textContent||t.innerText||""};t.addEventListener("input",r);const u=d=>{if(document.activeElement===t&&d.key==="Enter"&&!d.shiftKey){const c=s.trim();console.log("âš¡ Enter pressed, captured:",JSON.stringify(c)),c.length>0&&(n=c,console.log("ðŸ’¾ Stored for validation:",n))}};return document.addEventListener("keydown",u),h(),S(),console.log("âœ… Tracking initialized for current Perplexity chat"),!0}function h(){p&&p.disconnect(),p=new MutationObserver(r=>{r.forEach(u=>{u.type==="childList"&&Array.from(u.addedNodes).some(e=>{if(e.nodeType===1)try{return[e.querySelector&&e.querySelector('[data-testid*="conversation"]'),e.matches&&e.matches('[data-testid*="conversation"]'),e.querySelector&&e.querySelector('[class*="query"]'),e.querySelector&&e.querySelector('[class*="answer"]'),e.querySelector&&e.querySelector('[class*="response"]'),e.querySelector&&e.querySelector('[role="article"]'),e.matches&&e.matches('[role="article"]'),e.querySelector&&e.querySelector('[class*="loading"]'),e.querySelector&&e.querySelector('[class*="thinking"]'),e.className&&typeof e.className=="string"&&(e.className.includes("message")||e.className.includes("query")||e.className.includes("answer")||e.className.includes("response")),e.innerHTML&&e.innerHTML.length>100].some(y=>y)}catch{return!1}return!1})&&n.length>0&&(o++,chrome.storage.local.set({today_perplexity_prompts:o},()=>{chrome.runtime.lastError?console.error("âŒ Storage error:",chrome.runtime.lastError):console.log(`ðŸ“Š Saved Perplexity prompts count: ${o}`)}),console.log(`ðŸŸ¢ Perplexity Prompt #${o} sent: "${n.substring(0,50)}${n.length>50?"...":""}"`),n="",s="",console.log("ðŸ§¹ Cleared stored content"))})});const t=document.querySelector("main")||document.querySelector('[role="main"]')||document.querySelector("#__next")||document.querySelector('[class*="conversation"]')||document.querySelector('[class*="chat"]')||document.body;t&&p.observe(t,{childList:!0,subtree:!0})}function S(){const t=document.querySelector('[aria-label*="Send"]')||document.querySelector('[aria-label*="Submit"]')||document.querySelector('button[type="submit"]')||document.querySelector('[data-testid*="send"]')||document.querySelector('[class*="send"]')||document.querySelector("form button:last-child");t&&!t.hasAttribute("data-tracked")&&(t.setAttribute("data-tracked","true"),t.addEventListener("click",()=>{const r=s.trim();r.length>0&&(n=r,console.log("ðŸ–±ï¸ Send button clicked, captured content:",r.substring(0,50)))}))}function a(){i();const t=window.location.href;t!==a.lastUrl&&(console.log("ðŸ”„ URL changed, reinitializing..."),l=null,i(),a.lastUrl=t);const r=document.querySelector("#ask-input")||document.querySelector('[role="textbox"]')||document.querySelector('[contenteditable="true"]');r&&r!==l&&(console.log("ðŸ”„ New Perplexity input field detected, reinitializing..."),i())}a.lastUrl=window.location.href;window.getPromptCount=()=>o;window.resetPromptCount=()=>(o=0,chrome.storage.local.set({today_perplexity_prompts:0},()=>{chrome.runtime.lastError?console.error("âŒ Storage error during reset:",chrome.runtime.lastError):console.log("ðŸ”„ Perplexity prompts counter reset to 0")}),o);window.checkStorage=()=>{chrome.storage.local.get(["today_perplexity_prompts"],t=>{console.log("Current today_perplexity_prompts storage value:",t.today_perplexity_prompts),console.log("Current promptCount variable:",o)})};
