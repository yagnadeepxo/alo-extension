console.log("‚è∞ Universal LLM Time Tracker v2.0 loaded");(function(){const n={IDLE_TIMEOUT:6e4,STORAGE_PREFIX:"llm_tracker_"},a={isExtension:typeof chrome<"u"&&chrome.storage,async set(t,e){const s=n.STORAGE_PREFIX+t;if(this.isExtension)try{await chrome.storage.local.set({[s]:e}),console.log(`üíæ Saved to chrome storage: ${t} = ${e}`)}catch(i){console.warn("Chrome storage failed, using localStorage:",i),this.isExtension=!1,this.setLocal(s,e)}else this.setLocal(s,e)},async get(t,e=0){const s=n.STORAGE_PREFIX+t;if(this.isExtension)try{const o=(await chrome.storage.local.get([s]))[s]||e;return console.log(`üìñ Loaded from chrome storage: ${t} = ${o}`),o}catch(i){return console.warn("Chrome storage failed, using localStorage:",i),this.isExtension=!1,this.getLocal(s,e)}else return this.getLocal(s,e)},setLocal(t,e){try{localStorage.setItem(t,String(e)),console.log(`üíæ Saved to localStorage: ${t} = ${e}`)}catch(s){console.error("localStorage save failed:",s)}},getLocal(t,e){try{const s=localStorage.getItem(t),i=s!==null&&parseInt(s)||e;return console.log(`üìñ Loaded from localStorage: ${t} = ${i}`),i}catch(s){return console.error("localStorage read failed:",s),e}}};function c(){const t=window.location.hostname.toLowerCase();return t.includes("chatgpt.com")||t.includes("chat.openai.com")?"chatgpt":t.includes("claude.ai")?"claude":t.includes("deepseek.com")?"deepseek":t.includes("perplexity.ai")?"perplexity":t.includes("grok.com")||t.includes("x.ai")?"grok":t.includes("gemini.google.com")||t.includes("bard.google.com")?"gemini":t.includes("poe.com")?"poe":t.includes("character.ai")?"character":"unknown"}class h{constructor(){this.platform=c(),this.sessionStart=null,this.totalTime=0,this.isActive=!1,this.isVisible=!0,this.idleTimer=null,this.lastActivity=Date.now(),console.log(`üéØ Platform: ${this.platform}`),console.log(`üîß Storage: ${a.isExtension?"Chrome Extension":"localStorage"}`)}async init(){this.totalTime=await a.get(`${this.platform}_total_time`,0),console.log(`üìä Loaded total time: ${this.formatTime(this.totalTime)}`),this.startSession(),this.setupEventListeners(),this.setupResetListeners(),console.log("‚úÖ Time tracker initialized")}startSession(){this.isActive||(this.sessionStart=Date.now(),this.isActive=!0,this.lastActivity=Date.now(),this.resetIdleTimer(),console.log(`üü¢ Session started for ${this.platform}`))}async endSessionAndSave(){if(this.isActive&&this.sessionStart){const e=Date.now()-this.sessionStart;this.totalTime+=e,await a.set(`${this.platform}_total_time`,this.totalTime),console.log(`üî¥ Session ended: +${this.formatTime(e)} (Total: ${this.formatTime(this.totalTime)})`),this.isActive=!1,this.sessionStart=null,this.clearIdleTimer()}}pauseSession(){this.isActive&&(console.log("‚è∏Ô∏è Session paused (idle timeout)"),this.isActive=!1,this.clearIdleTimer())}resetIdleTimer(){this.clearIdleTimer(),this.idleTimer=setTimeout(()=>{console.log(`üí§ User idle for ${n.IDLE_TIMEOUT/1e3}s, pausing timer`),this.pauseSession()},n.IDLE_TIMEOUT)}clearIdleTimer(){this.idleTimer&&(clearTimeout(this.idleTimer),this.idleTimer=null)}handleActivity(){this.lastActivity=Date.now(),this.isVisible&&!this.isActive?this.startSession():this.isActive&&this.resetIdleTimer()}setupResetListeners(){window.addEventListener("llm-tracker-reset",e=>{console.log("üîÑ Received reset event from content script:",e.detail),this.handleReset("custom-event")}),window.addEventListener("message",e=>{e.source!==window||!e.data?.type||e.data.type==="LLM_TRACKER_RESET"&&(console.log("üîÑ Received reset message from content script:",e.data),this.handleReset("window-message"))}),a.isExtension&&chrome.storage.onChanged.addListener((e,s)=>{if(s==="local"){const i=n.STORAGE_PREFIX+`${this.platform}_total_time`;e[i]&&e[i].newValue===0&&e[i].oldValue>0&&(console.log("üîÑ Detected storage reset for platform:",this.platform),this.handleReset("storage-change"))}}),console.log("üéß Reset listeners setup complete")}async handleReset(e){console.log(`üîÑ Handling reset from ${e} for platform: ${this.platform}`),this.pauseSession(),this.totalTime=0,this.sessionStart=null,this.isActive=!1,await a.set(`${this.platform}_total_time`,0),console.log(`‚úÖ ${this.platform} tracker reset completed via ${e}`),this.isVisible&&this.lastActivity>Date.now()-n.IDLE_TIMEOUT&&(console.log("üîÑ Restarting session after reset"),this.startSession())}setupEventListeners(){["mousedown","mousemove","keydown","scroll","touchstart"].forEach(s=>{document.addEventListener(s,()=>this.handleActivity(),{passive:!0})}),document.addEventListener("visibilitychange",()=>{document.hidden?(console.log("üëÅÔ∏è Tab hidden - saving session"),this.isVisible=!1,this.endSessionAndSave()):(console.log("üëÅÔ∏è Tab visible"),this.isVisible=!0,this.lastActivity>Date.now()-n.IDLE_TIMEOUT&&this.startSession())}),window.addEventListener("blur",()=>{console.log("üò¥ Window blurred - saving session"),this.endSessionAndSave()}),window.addEventListener("focus",()=>{console.log("üéØ Window focused"),this.isVisible=!0,this.lastActivity>Date.now()-n.IDLE_TIMEOUT&&this.startSession()}),window.addEventListener("beforeunload",()=>{if(console.log("üíæ Page unloading - saving session"),this.isActive&&this.sessionStart){const s=Date.now()-this.sessionStart,i=this.totalTime+s;try{const o=n.STORAGE_PREFIX+`${this.platform}_total_time`;localStorage.setItem(o,String(i)),console.log(`üíæ Saved ${this.formatTime(s)} on unload (Total: ${this.formatTime(i)})`)}catch(o){console.error("Failed to save on unload:",o)}}})}getCurrentSessionTime(){return this.isActive&&this.sessionStart?Date.now()-this.sessionStart:0}getTotalTime(){return this.totalTime+this.getCurrentSessionTime()}formatTime(e){const s=Math.floor(e/1e3),i=Math.floor(s/60),o=Math.floor(i/60),l=Math.floor(o/24);return l>0?`${l}d ${o%24}h ${i%60}m`:o>0?`${o}h ${i%60}m`:i>0?`${i}m ${s%60}s`:`${s}s`}async reset(){console.log(`üîÑ Manual reset called for ${this.platform}`),await this.handleReset("manual-api-call")}getStats(){return{platform:this.platform,isActive:this.isActive,isVisible:this.isVisible,sessionTime:this.getCurrentSessionTime(),totalTime:this.getTotalTime(),storageType:a.isExtension?"Chrome Extension":"localStorage",formatted:{session:this.formatTime(this.getCurrentSessionTime()),total:this.formatTime(this.getTotalTime())}}}}const r=new h;window.llmTimeTracker={getStats:()=>r.getStats(),reset:()=>r.reset(),forceStart:()=>r.startSession(),forceEnd:()=>r.endSessionAndSave(),export:()=>{const t=r.getStats();return console.log(`üìä ${r.platform} Time Tracker Export:`,t),t}},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>r.init()):r.init(),console.log(`‚úÖ ${r.platform} Time Tracker v2.0 ready`)})();
